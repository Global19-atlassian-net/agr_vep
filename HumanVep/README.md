# Human VEP annotation pipeline

- Runs VEP on human variant VCF file (obtained from the EnsEMBL FTP site).
- Splits input files, runs VEP in parallel, then combines the output.
- Uses the EnsEMBL merged (EnsEMBL & RefSeq) cached database to retrieve VEP annotations.


## Requirements

See the links below for associated dependencies and required databases

- EnsEMBL Hive ([eHive docs](https://ensembl-hive.readthedocs.io/en/version2.5/quickstart/install.html))
- EnsEMBL VEP ([VEP docs](https://m.ensembl.org/info/docs/tools/vep/script/vep_download.html#installer))

Perl libraries:
- File::Copy
- File::Path
- Data::Dumper


## Installation

The following variables need to be set in the `initialise_pipeline.sh` script:
- `rs_fasta_prefix` - path of the chromosome FASTA files prefixing the chromosome name/number.
- `rs_fasta_suffix` - part of the chromosome FASTA filenames suffixing the chromosome name/number.
- `ens_var_prefix` - path of the chromosome-specific VCF files prefixing the chromosome name/number.
- `ens_var_suffix` - part of the chromosome-specific VCF filenames suffixing the chromosoms name/number.
- `vep_cache_dir` - directory containing EnsEMBL VEP cache files for human database.
- `vep_cache` - merged / refseq / ensembl (should normally be set to merged for AGR)
- `hive_root_dir` - root directory containing EnsEMBL eHive Perl modules.
- `pipeline_base_dir` - location for files generated by pipeline to be saved.
- `pipeline_host` - MySQL database server for pipeline databases.
- `pipeline_user` - MySQL user.
- `pipeline_port` - MySQL server port.
- `lsf_queue` - name of the LSF queue used for running jobs on the cluster.
- `sift_dir` - VEP installation directory.
- `vep_dir` - PolyPhen2 installation directory.

The pipeline should be initialised using the `initialise_pipeline.sh` script.  The password for the MySQL databases needs to be specified as the first argument.
- Enter a `screen` or `tmux` session
- Run the pipeline initialisation script - e.g. `./initialise_pipeline.sh mysql_pass`.
- Copy and execute the appropriate line from the output to set the `$EHIVE_URL` environmental variable.
- Run the pipeline - `beekeeper.pl $EHIVE_URL -loop`.


## Pipeline runnable details

### SplitInput.pm

- Splits input VCF files and writes to chromosome-specific directories with 3-digit suffixes.


### RunVep.pm

- Runs VEP on split files.
- Removes header lines from all output files except first file for chromosome 1.


### RunPartialVep.pm

- Only runs if RunVep.pm failed for a file.
- Runs VEP on any variants that weren't processed by RunVep.pm (with higher memory allocation).
- Combines output with original output from RunVep.pm.


### CombineOutput.pm

- Combines VEP output for all chromosomes into single file.
- Removes temporary files.
